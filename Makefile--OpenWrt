# 
# Copyright (C) 2006-2008 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk
include $(INCLUDE_DIR)/kernel.mk

PKG_NAME:=scutclient
PKG_VERSION:=1.6
PKG_SOURCE_VERSION:=a060a93
PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION)-$(PKG_SOURCE_VERSION).tar.gz
PKG_SOURCE_URL:=git://github.com/libc0607/scutclient.git
PKG_SOURCE_PROTO:=git
PKG_SOURCE_SUBDIR:=$(PKG_NAME)-$(PKG_VERSION)-$(PKG_SOURCE_VERSION)


include $(INCLUDE_DIR)/package.mk

define Package/scutclient
  SECTION:=net
  CATEGORY:=Network
  TITLE:=SCUT 802.1X client by Forward
  DEPENDS:=
endef

define Package/scutclient/description
 Support SCUT private authentication protocol.
 Thanks to njit8021xclient make by liuqun.
endef

TARGET_CFLAGS += \
	-ffunction-sections \
	-fdata-sections

CONFIGURE_VARS += \
	ac_cv_linux_vers=$(LINUX_VERSION) \
	ac_cv_header_libusb_1_0_libusb_h=no \
	ac_cv_netfilter_can_compile=no


CONFIGURE_ARGS += \
	--enable-shared \
	--enable-static \
	--disable-yydebug \
	--enable-ipv6 \
	--with-build-cc="$(HOSTCC)" \
	--with-pcap=linux \
	--without-septel \
	--without-dag \
	--without-libnl \
	--disable-can

define Build/Prepare
$(call Build/Prepare/Default)
endef

define Build/Configure
$(call Build/Configure/Default)
endef

define Package/scutclient/conffiles
/etc/config/scutclient
endef


#下面的postinst/prerm只在cc及以上版本才有效

define Package/scutclient/postinst
#!/bin/sh
if [ -z "$${IPKG_INSTROOT}" ]; then
	echo "5 6 * * 1-5 /etc/init.d/scutclient restart" >> /etc/crontabs/root
	echo "00 12 * * 0-7 ntpd –n –d –p s2g.time.edu.cn" >> /etc/crontabs/root
	echo "30 02 * * 0-4 wifi down" >> /etc/crontabs/root	
	echo "05 06 * * 0-4 wifi up" >> /etc/crontabs/root
	echo "03 03 * * 1,3,5 reboot" >> /etc/crontabs/root
	echo "请打开192.168.1.1，登陆后在服务-scutclient设置中完成设置。"
	echo "请在系统-计划任务处检查定时配置是否正确。"
	rm -rf /tmp/luci-*cache
fi
exit 0
endef

define Package/scutclient/prerm
#!/bin/sh
if [ -z "$${IPKG_INSTROOT}" ]; then
	/etc/init.d/scutclient logoff
	sed -i '/scutclient/d' /etc/crontabs/root
	sed -i '/wifi/d' /etc/crontabs/root
	sed -i '/s2g.time.edu.cn/d' /etc/crontabs/root
fi
exit 0
endef

define Package/scutclient/install
	$(INSTALL_DIR) $(1)/etc/config
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/config/scutclient $(1)/etc/config/scutclient
	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/config/init.d $(1)/etc/init.d/scutclient
	$(INSTALL_DIR) $(1)/usr/lib/lua/luci/view/scutclient
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/luci/view-logs.htm $(1)/usr/lib/lua/luci/view/scutclient/logs.htm
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/luci/view-status.htm $(1)/usr/lib/lua/luci/view/scutclient/status.htm
	$(INSTALL_DIR) $(1)/usr/lib/lua/luci/controller
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/luci/controller-scutclient.lua $(1)/usr/lib/lua/luci/controller/scutclient.lua
	$(INSTALL_DIR) $(1)/usr/lib/lua/luci/model/cbi/scutclient
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/luci/model-scutclient.lua $(1)/usr/lib/lua/luci/model/cbi/scutclient/scutclient.lua
	$(MAKE) -C $(PKG_BUILD_DIR) install-exec DESTDIR=$(1) 
endef

$(eval $(call BuildPackage,scutclient))
